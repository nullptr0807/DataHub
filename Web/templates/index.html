<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DataHub Control Center</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #101418;
      color: #f3f6fa;
    }
    main {
      width: 100%;
      max-width: min(1280px, 94vw);
      margin: 0 auto;
      padding: clamp(20px, 4vw, 40px);
      box-sizing: border-box;
    }
    h1 {
      margin-top: 0;
      font-size: clamp(1.8rem, 1.6vw + 1.4rem, 2.6rem);
    }
    h2 {
      font-size: clamp(1.35rem, 1vw + 1.1rem, 1.8rem);
      margin-top: 0;
    }
    section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 18px;
      padding: clamp(18px, 4vw, 30px);
      margin-bottom: clamp(28px, 4vw, 42px);
      box-shadow: 0 22px 50px rgba(0, 0, 0, 0.22);
    }
    .tabs {
      display: flex;
      gap: 12px;
      margin: 12px 0 24px;
    }
    .tab {
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: transparent;
      color: inherit;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background 0.18s ease, border-color 0.18s ease;
    }
    .tab:hover {
      border-color: rgba(255, 255, 255, 0.25);
    }
    .tab.active {
      background: linear-gradient(135deg, #0ea5e9, #6366f1);
      border-color: transparent;
      color: white;
    }
    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: clamp(14px, 2.5vw, 20px);
      align-items: end;
    }
    label {
      display: flex;
      flex-direction: column;
      font-size: clamp(0.88rem, 0.3vw + 0.82rem, 1rem);
      gap: 6px;
    }
    select, input {
      appearance: none;
      border: 1px solid rgba(255, 255, 255, 0.16);
      border-radius: 10px;
      padding: 10px 14px;
      font-size: clamp(0.95rem, 0.3vw + 0.88rem, 1.05rem);
      background: rgba(12, 18, 24, 0.85);
      color: inherit;
    }
    button {
      padding: 12px 20px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      font-size: clamp(1rem, 0.35vw + 0.95rem, 1.15rem);
      background: linear-gradient(135deg, #0ea5e9, #6366f1);
      color: white;
      cursor: pointer;
      transition: filter 0.18s ease-in-out;
    }
    button:hover {
      filter: brightness(1.08);
    }
    .status-line {
      margin-top: 16px;
      font-size: 0.95rem;
      min-height: 1.3em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 0.94rem;
    }
    th, td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    }
    th {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.8;
    }
    pre {
      background: rgba(12, 18, 24, 0.85);
      padding: 14px;
      border-radius: 10px;
      overflow-x: auto;
      font-size: 0.85rem;
    }
    .muted {
      opacity: 0.72;
      font-size: 0.85rem;
    }
    .empty-note {
      margin: 0;
    }
    .layout-grid {
      display: grid;
      gap: clamp(18px, 3vw, 32px);
    }
    .panel-card {
      background: rgba(12, 18, 24, 0.78);
      border-radius: 16px;
      padding: clamp(18px, 3vw, 28px);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
      width: 100%;
      box-sizing: border-box;
    }
    .chart-card {
      display: flex;
      flex-direction: column;
      gap: clamp(12px, 2vw, 18px);
    }
    .panel-stack {
      display: flex;
      flex-direction: column;
      gap: clamp(18px, 2.5vw, 28px);
      min-width: 0;
    }
    .panel-card h3 {
      margin-top: 0;
      margin-bottom: 14px;
      font-size: clamp(1.0rem, 0.8vw + 0.9rem, 1.2rem);
    }
    @media (min-width: 1100px) {
      .unit-layout,
      .range-layout {
        grid-template-columns: minmax(320px, 1.2fr) minmax(0, 2fr);
        align-items: start;
      }
    }
    @media (max-width: 700px) {
      main {
        max-width: 100vw;
      }
      form {
        grid-template-columns: 1fr;
      }
    }
    .sub-tabs {
      display: flex;
      gap: 10px;
      margin: 12px 0 20px;
      flex-wrap: wrap;
    }
    .sub-tab {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: transparent;
      color: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.18s ease, border-color 0.18s ease;
    }
    .sub-tab:hover {
      border-color: rgba(255, 255, 255, 0.25);
    }
    .sub-tab.active {
      background: rgba(99, 102, 241, 0.18);
      border-color: rgba(99, 102, 241, 0.65);
    }
    .sub-panel {
      display: none;
    }
    .sub-panel.active {
      display: block;
    }
    .chart-grid {
      margin-top: 0;
      display: grid;
      gap: 22px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }
    .chart-block {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 0;
    }
    .chart-single {
      margin-top: 0;
    }
    .chart-grid h3,
    .chart-single h3 {
      margin: 0 0 12px;
      font-size: 1.05rem;
    }
    .chart-wrap {
      position: relative;
      width: 100%;
      height: clamp(240px, 32vw, 420px);
      background: rgba(12, 18, 24, 0.7);
      border-radius: 12px;
      padding: 0;
      box-sizing: border-box;
      overflow: hidden;
    }
    .chart-wrap canvas {
      position: absolute;
      inset: 0;
      width: 100% !important;
      height: 100% !important;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
  <main>
    <h1>DataHub Control Center</h1>
    <nav class="tabs" aria-label="Strategy Tabs">
      <button class="tab active" data-tab="backtest">Back Test</button>
    </nav>

    <section class="tab-panel active" data-tab-panel="backtest">
      <h2>Grid Backtest</h2>
      {{if .CSVFiles}}
      <div class="sub-tabs" aria-label="Backtest Modes">
        <button class="sub-tab active" data-sub-tab="unit">Unit Test</button>
        <button class="sub-tab" data-sub-tab="range">Range Test</button>
      </div>

      <div class="sub-panel active" data-sub-panel="unit">
        <div class="layout-grid unit-layout">
          <div class="panel-card">
            <h3>Parameters</h3>
            <form id="unit-form">
              <label>
                Dataset
                <select name="data" id="unit-data">
                  {{range .CSVFiles}}
                    <option value="{{.Value}}" {{if eq $.DefaultData .Value}}selected{{end}}>{{.Label}}</option>
                  {{end}}
                </select>
              </label>
              <label>
                Lower bound
                <input type="number" step="0.01" name="lower" id="unit-lower" value="80000" required />
              </label>
              <label>
                Upper bound
                <input type="number" step="0.01" name="upper" id="unit-upper" value="120000" required />
              </label>
              <label>
                Levels
                <input type="number" min="2" name="levels" id="unit-levels" value="{{.DefaultLevels}}" required />
              </label>
              <label>
                Days back
                <input type="number" min="1" name="days_back" id="unit-days-back" value="{{.DefaultDaysBack}}" />
              </label>
              <label>
                Fee rate
                <input type="number" step="0.0001" name="fee" id="unit-fee" value="0.001" />
              </label>
              <label>
                Quote balance
                <input type="number" step="0.01" name="quote_balance" id="unit-quote" value="10000" />
              </label>
              <label>
                Base balance
                <input type="number" step="0.00000001" name="base_balance" id="unit-base" value="0" />
              </label>
              <label>
                Risk-free rate
                <input type="number" step="0.0001" name="risk_free" id="unit-risk-free" value="{{printf "%.4f" .DefaultRiskFree}}" />
              </label>
              <div>
                <button type="submit">Run Unit Test</button>
              </div>
            </form>
            <div id="unit-status" class="muted status-line"></div>
          </div>
          <div class="panel-stack">
            <div id="unit-results" class="panel-card">
              <h3>Performance</h3>
              <p class="muted empty-note">Run a unit test to see performance metrics.</p>
            </div>
            <div class="panel-card chart-card">
              <h3>Charts</h3>
              <div class="chart-grid">
                <div class="chart-block">
                  <h3>Price &amp; Trades</h3>
                  <div class="chart-wrap">
                    <canvas id="price-chart"></canvas>
                  </div>
                </div>
                <div class="chart-block">
                  <h3>Equity Curve</h3>
                  <div class="chart-wrap">
                    <canvas id="equity-chart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div id="unit-raw" class="panel-card" hidden></div>
          </div>
        </div>
      </div>

      <div class="sub-panel" data-sub-panel="range">
        <div class="layout-grid range-layout">
          <div class="panel-card">
            <h3>Parameters</h3>
            <form id="range-form">
              <label>
                Dataset
                <select name="data" id="range-data">
                  {{range .CSVFiles}}
                    <option value="{{.Value}}" {{if eq $.DefaultData .Value}}selected{{end}}>{{.Label}}</option>
                  {{end}}
                </select>
              </label>
              <label>
                Lower bound
                <input type="number" step="0.01" name="lower" id="range-lower" value="80000" required />
              </label>
              <label>
                Upper bound
                <input type="number" step="0.01" name="upper" id="range-upper" value="120000" required />
              </label>
              <label>
                Min levels
                <input type="number" min="2" name="min_levels" id="range-min-levels" value="{{.DefaultLevels}}" required />
              </label>
              <label>
                Max levels
                <input type="number" min="2" name="max_levels" id="range-max-levels" value="{{.DefaultLevels}}" required />
              </label>
              <label>
                Level step
                <input type="number" min="1" name="level_step" id="range-step" value="1" required />
              </label>
              <label>
                Days back
                <input type="number" min="1" name="days_back" id="range-days-back" value="{{.DefaultDaysBack}}" />
              </label>
              <label>
                Fee rate
                <input type="number" step="0.0001" name="fee" id="range-fee" value="0.001" />
              </label>
              <label>
                Quote balance
                <input type="number" step="0.01" name="quote_balance" id="range-quote" value="10000" />
              </label>
              <label>
                Base balance
                <input type="number" step="0.00000001" name="base_balance" id="range-base" value="0" />
              </label>
              <label>
                Risk-free rate
                <input type="number" step="0.0001" name="risk_free" id="range-risk-free" value="{{printf "%.4f" .DefaultRiskFree}}" />
              </label>
              <div>
                <button type="submit">Run Range Test</button>
              </div>
            </form>
            <div id="range-status" class="muted status-line"></div>
          </div>
          <div class="panel-stack">
            <div id="range-summary" class="panel-card">
              <h3>Highlights</h3>
              <p class="muted empty-note">Run a range test to compare grid levels.</p>
            </div>
            <div class="panel-card chart-card">
              <h3>ROI vs Levels</h3>
              <div class="chart-wrap">
                <canvas id="range-chart"></canvas>
              </div>
            </div>
            <div id="range-results" class="panel-card">
              <h3>Scenarios</h3>
              <p class="muted empty-note">Level-by-level results will appear here.</p>
            </div>
            <div id="range-raw" class="panel-card" hidden></div>
          </div>
        </div>
      </div>
      {{else}}
        <p>No CSV data files found under <code>Collector/data</code>. Populate the directory and reload.</p>
      {{end}}
    </section>
  </main>
  <script>
    const tabs = Array.from(document.querySelectorAll('.tab'));
    const panels = Array.from(document.querySelectorAll('.tab-panel'));

    function activateTab(id) {
      tabs.forEach(tab => {
        const isActive = tab.dataset.tab === id;
        tab.classList.toggle('active', isActive);
        tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
        tab.setAttribute('tabindex', isActive ? '0' : '-1');
      });
      panels.forEach(panel => {
        const isActive = panel.dataset.tabPanel === id;
        panel.classList.toggle('active', isActive);
        panel.hidden = !isActive;
      });
    }

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        activateTab(tab.dataset.tab);
      });
      tab.addEventListener('keydown', event => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          activateTab(tab.dataset.tab);
        }
      });
    });

    if (tabs.length > 0) {
      activateTab(tabs[0].dataset.tab);
    }

    const subTabs = Array.from(document.querySelectorAll('.sub-tab'));
    const subPanels = Array.from(document.querySelectorAll('.sub-panel'));

    function activateSubTab(id) {
      subTabs.forEach(tab => {
        const isActive = tab.dataset.subTab === id;
        tab.classList.toggle('active', isActive);
        tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
        tab.setAttribute('tabindex', isActive ? '0' : '-1');
      });
      subPanels.forEach(panel => {
        const isActive = panel.dataset.subPanel === id;
        panel.classList.toggle('active', isActive);
        panel.hidden = !isActive;
      });
    }

    subTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        activateSubTab(tab.dataset.subTab);
      });
      tab.addEventListener('keydown', event => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          activateSubTab(tab.dataset.subTab);
        }
      });
    });

    if (subTabs.length > 0) {
      activateSubTab(subTabs[0].dataset.subTab);
    }

  const unitForm = document.getElementById('unit-form');
  const unitStatus = document.getElementById('unit-status');
  const unitResults = document.getElementById('unit-results');
  const unitRaw = document.getElementById('unit-raw');
  const priceCanvas = document.getElementById('price-chart');
  const equityCanvas = document.getElementById('equity-chart');
  const unitDataSelect = document.getElementById('unit-data');
  const unitLowerInput = document.getElementById('unit-lower');
  const unitUpperInput = document.getElementById('unit-upper');
  const unitLevelsInput = document.getElementById('unit-levels');
  const unitDaysBackInput = document.getElementById('unit-days-back');
  const unitFeeInput = document.getElementById('unit-fee');
  const unitQuoteInput = document.getElementById('unit-quote');
  const unitBaseInput = document.getElementById('unit-base');
  const unitRiskFreeInput = document.getElementById('unit-risk-free');
  const unitResultsEmpty = '<h3>Performance</h3><p class="muted empty-note">Run a unit test to see performance metrics.</p>';
  const rangeSummaryEmpty = '<h3>Highlights</h3><p class="muted empty-note">Run a range test to compare grid levels.</p>';
  const rangeResultsEmpty = '<h3>Scenarios</h3><p class="muted empty-note">Level-by-level results will appear here.</p>';
    let priceChartInstance = null;
    let equityChartInstance = null;
    let rangeChartInstance = null;

    function formatPercent(value) {
      if (value === null || value === undefined || Number.isNaN(value)) {
        return 'n/a';
      }
      return (value * 100).toFixed(2) + '%';
    }

    function renderUnitMetrics(result) {
      const sharpe = result.sharpe_ratio === null || result.sharpe_ratio === undefined ? 'n/a' : result.sharpe_ratio.toFixed(4);
      unitResults.innerHTML = `
        <h3>Performance</h3>
        <table>
          <tbody>
            <tr><th>Initial Equity</th><td>${result.initial_equity.toFixed(2)} USDT</td></tr>
            <tr><th>Final Equity</th><td>${result.equity.toFixed(2)} USDT</td></tr>
            <tr><th>Return</th><td>${formatPercent(result.roi)}</td></tr>
            <tr><th>BTC Return</th><td>${formatPercent(result.price_return)}</td></tr>
            <tr><th>Alpha</th><td>${formatPercent(result.alpha)}</td></tr>
            <tr><th>Sharpe Ratio</th><td>${sharpe}</td></tr>
            <tr><th>Buy Count</th><td>${result.buy_count}</td></tr>
            <tr><th>Sell Count</th><td>${result.sell_count}</td></tr>
            <tr><th>Skipped Buys</th><td>${result.skipped_buys}</td></tr>
            <tr><th>Skipped Sells</th><td>${result.skipped_sells}</td></tr>
            <tr><th>Share Value</th><td>${result.share_value.toFixed(2)} USDT</td></tr>
            <tr><th>Final Price</th><td>${result.final_price.toFixed(2)} USDT</td></tr>
          </tbody>
        </table>
      `;
    }

    function buildTimeSeries(entries, valueKey) {
      return (entries || [])
        .map(item => {
          const ts = Date.parse(item.timestamp);
          if (Number.isNaN(ts)) {
            return null;
          }
          return { x: ts, y: item[valueKey] };
        })
        .filter(Boolean);
    }

    function renderUnitCharts(result) {
      if (!window.Chart) {
        return;
      }

      const priceSeries = buildTimeSeries(result.candles, 'close');
      const equitySeries = buildTimeSeries(result.equity_curve, 'equity');
      const buyMarkers = (result.trades || [])
        .filter(trade => trade.type === 'buy')
        .map(trade => {
          const ts = Date.parse(trade.timestamp);
          return Number.isNaN(ts) ? null : { x: ts, y: trade.price };
        })
        .filter(Boolean);
      const sellMarkers = (result.trades || [])
        .filter(trade => trade.type === 'sell')
        .map(trade => {
          const ts = Date.parse(trade.timestamp);
          return Number.isNaN(ts) ? null : { x: ts, y: trade.price };
        })
        .filter(Boolean);

      const axisColor = 'rgba(199, 210, 222, 0.7)';
      const gridColor = 'rgba(148, 163, 184, 0.18)';

      if (priceCanvas) {
        if (priceChartInstance) {
          priceChartInstance.destroy();
        }

        const gridDatasets = [];
        if (priceSeries.length >= 2) {
          const firstTs = priceSeries[0].x;
          const lastTs = priceSeries[priceSeries.length - 1].x;
          (result.grid_levels || []).forEach(level => {
            gridDatasets.push({
              type: 'line',
              label: '',
              data: [
                { x: firstTs, y: level },
                { x: lastTs, y: level },
              ],
              borderColor: 'rgba(148, 163, 184, 0.28)',
              borderDash: [6, 6],
              borderWidth: 1,
              pointRadius: 0,
              hitRadius: 0,
              hoverRadius: 0,
            });
          });
        }

        priceChartInstance = new Chart(priceCanvas.getContext('2d'), {
          type: 'line',
          data: {
            datasets: [
              {
                label: 'Price',
                data: priceSeries,
                borderColor: '#0ea5e9',
                borderWidth: 2,
                tension: 0.15,
                pointRadius: 0,
              },
              ...gridDatasets,
              {
                type: 'scatter',
                label: 'Buys',
                data: buyMarkers,
                backgroundColor: '#22c55e',
                borderColor: '#22c55e',
                pointRadius: 4,
              },
              {
                type: 'scatter',
                label: 'Sells',
                data: sellMarkers,
                backgroundColor: '#f97316',
                borderColor: '#f97316',
                pointRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'nearest', intersect: false },
            scales: {
              x: {
                type: 'time',
                ticks: { color: axisColor, maxTicksLimit: 6 },
                grid: { color: 'rgba(148, 163, 184, 0.1)' },
              },
              y: {
                ticks: { color: axisColor, maxTicksLimit: 6 },
                grid: { color: gridColor },
              },
            },
            plugins: {
              legend: {
                labels: {
                  color: axisColor,
                  filter: item => item.text !== '',
                },
              },
              tooltip: {
                callbacks: {
                  label: context => {
                    const label = context.dataset.label || '';
                    const value = context.parsed.y;
                    return `${label}: ${value.toFixed(2)}`;
                  },
                },
              },
            },
          },
        });
      }

      if (equityCanvas) {
        if (equityChartInstance) {
          equityChartInstance.destroy();
        }

        equityChartInstance = new Chart(equityCanvas.getContext('2d'), {
          type: 'line',
          data: {
            datasets: [
              {
                label: 'Equity',
                data: equitySeries,
                borderColor: '#6366f1',
                borderWidth: 2,
                tension: 0.2,
                pointRadius: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'nearest', intersect: false },
            scales: {
              x: {
                type: 'time',
                ticks: { color: axisColor, maxTicksLimit: 6 },
                grid: { color: 'rgba(148, 163, 184, 0.1)' },
              },
              y: {
                ticks: { color: axisColor, maxTicksLimit: 6 },
                grid: { color: gridColor },
              },
            },
            plugins: {
              legend: { labels: { color: axisColor } },
            },
          },
        });
      }
    }

    async function submitUnit(event) {
      event.preventDefault();
      if (!unitForm) {
        return;
      }
      unitStatus.textContent = 'Running unit test...';
      unitResults.innerHTML = unitResultsEmpty;
      unitRaw.innerHTML = '';
      unitRaw.hidden = true;
      if (priceChartInstance) {
        priceChartInstance.destroy();
        priceChartInstance = null;
      }
      if (equityChartInstance) {
        equityChartInstance.destroy();
        equityChartInstance = null;
      }

      const payload = {
        mode: 'unit',
        data: unitDataSelect ? unitDataSelect.value : '',
        lower: parseFloat(unitLowerInput?.value || '0'),
        upper: parseFloat(unitUpperInput?.value || '0'),
        levels: parseInt(unitLevelsInput?.value || '0', 10),
        days_back: parseInt(unitDaysBackInput?.value || '0', 10),
        fee: parseFloat(unitFeeInput?.value || '0'),
        quote_balance: parseFloat(unitQuoteInput?.value || '0'),
        base_balance: parseFloat(unitBaseInput?.value || '0'),
        risk_free: parseFloat(unitRiskFreeInput?.value || '0'),
      };

      try {
        const response = await fetch('/api/backtest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await response.json();
        if (!response.ok || !data.success || !data.unit_result) {
          unitStatus.textContent = data.error || 'Unit test failed.';
          if (data.raw_output) {
            unitRaw.innerHTML = `<h3>Diagnostics</h3><pre>${data.raw_output}</pre>`;
            unitRaw.hidden = false;
          }
          return;
        }
        unitStatus.textContent = 'Unit test complete.';
        renderUnitMetrics(data.unit_result);
        renderUnitCharts(data.unit_result);
        unitRaw.innerHTML = '';
        unitRaw.hidden = true;
      } catch (error) {
        console.error(error);
        unitStatus.textContent = 'Unexpected error. Check console logs.';
        unitRaw.innerHTML = '';
        unitRaw.hidden = true;
      }
    }

    if (unitForm) {
      unitForm.addEventListener('submit', submitUnit);
    }

  const rangeForm = document.getElementById('range-form');
  const rangeStatus = document.getElementById('range-status');
  const rangeSummary = document.getElementById('range-summary');
  const rangeResults = document.getElementById('range-results');
  const rangeRaw = document.getElementById('range-raw');
  const rangeChartCanvas = document.getElementById('range-chart');
  const rangeDataSelect = document.getElementById('range-data');
  const rangeLowerInput = document.getElementById('range-lower');
  const rangeUpperInput = document.getElementById('range-upper');
  const rangeMinLevelsInput = document.getElementById('range-min-levels');
  const rangeMaxLevelsInput = document.getElementById('range-max-levels');
  const rangeStepInput = document.getElementById('range-step');
  const rangeDaysBackInput = document.getElementById('range-days-back');
  const rangeFeeInput = document.getElementById('range-fee');
  const rangeQuoteInput = document.getElementById('range-quote');
  const rangeBaseInput = document.getElementById('range-base');
  const rangeRiskFreeInput = document.getElementById('range-risk-free');

  if (unitResults && !unitResults.innerHTML.trim()) {
    unitResults.innerHTML = unitResultsEmpty;
  }
  if (rangeSummary && !rangeSummary.innerHTML.trim()) {
    rangeSummary.innerHTML = rangeSummaryEmpty;
  }
  if (rangeResults && !rangeResults.innerHTML.trim()) {
    rangeResults.innerHTML = rangeResultsEmpty;
  }

    function renderRangeSummary(summary) {
      if (!summary) {
        rangeSummary.innerHTML = rangeSummaryEmpty;
        return;
      }
      let sharpeText = 'n/a';
      if (summary.best_sharpe) {
        const ratio = summary.best_sharpe.sharpe_ratio;
        const ratioText = ratio === null || ratio === undefined ? 'n/a' : ratio.toFixed(4);
        sharpeText = `${summary.best_sharpe.levels} levels (${formatPercent(summary.best_sharpe.roi)}, Sharpe ${ratioText})`;
      }
      rangeSummary.innerHTML = `
        <h3>Highlights</h3>
        <table>
          <tbody>
            <tr><th>Best ROI</th><td>${summary.best_roi.levels} levels (${formatPercent(summary.best_roi.roi)})</td></tr>
            <tr><th>Best Sharpe</th><td>${sharpeText}</td></tr>
          </tbody>
        </table>
      `;
    }

    function renderRangeTable(results) {
      if (!results || results.length === 0) {
        rangeResults.innerHTML = rangeResultsEmpty;
        return;
      }

      const rows = results.map(entry => {
        const sharpe = entry.sharpe_ratio === null || entry.sharpe_ratio === undefined ? 'n/a' : entry.sharpe_ratio.toFixed(4);
        return `
          <tr>
            <td>${entry.levels}</td>
            <td>${formatPercent(entry.roi)}</td>
            <td>${formatPercent(entry.price_return)}</td>
            <td>${formatPercent(entry.alpha)}</td>
            <td>${sharpe}</td>
            <td>${entry.final_equity.toFixed(2)}</td>
            <td>${entry.buy_count}/${entry.sell_count}</td>
            <td>${entry.skipped_buys}/${entry.skipped_sells}</td>
          </tr>
        `;
      }).join('');

      rangeResults.innerHTML = `
        <h3>Scenarios</h3>
        <table>
          <thead>
            <tr>
              <th>Levels</th>
              <th>ROI</th>
              <th>BTC Return</th>
              <th>Alpha</th>
              <th>Sharpe</th>
              <th>Final Equity</th>
              <th>Buys/Sells</th>
              <th>Skipped</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    function renderRangeChart(results) {
      if (!window.Chart || !rangeChartCanvas) {
        return;
      }
      if (rangeChartInstance) {
        rangeChartInstance.destroy();
        rangeChartInstance = null;
      }
      if (!results || results.length === 0) {
        return;
      }

      const points = results
        .map(entry => {
          const levels = Number(entry.levels);
          const roi = Number(entry.roi);
          if (Number.isNaN(levels) || Number.isNaN(roi)) {
            return null;
          }
          return { x: levels, y: roi * 100 };
        })
        .filter(Boolean);

      if (points.length === 0) {
        return;
      }

      const axisColor = 'rgba(199, 210, 222, 0.7)';
      const gridColor = 'rgba(148, 163, 184, 0.15)';

      rangeChartInstance = new Chart(rangeChartCanvas.getContext('2d'), {
        type: 'line',
        data: {
          datasets: [
            {
              label: 'ROI (%)',
              data: points,
              borderColor: '#38bdf8',
              backgroundColor: '#38bdf8',
              borderWidth: 2,
              tension: 0.25,
              pointRadius: 4,
              pointHoverRadius: 6,
              spanGaps: true,
              parsing: false,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'linear',
              ticks: { color: axisColor },
              title: { display: true, text: 'Grid Levels', color: 'rgba(226, 232, 240, 0.9)' },
              grid: { color: gridColor },
            },
            y: {
              ticks: { color: axisColor },
              title: { display: true, text: 'ROI (%)', color: 'rgba(226, 232, 240, 0.9)' },
              grid: { color: gridColor },
            },
          },
          plugins: {
            legend: { labels: { color: axisColor } },
            tooltip: {
              callbacks: {
                label: context => `${context.parsed.x} levels â†’ ${context.parsed.y.toFixed(2)}%`,
              },
            },
          },
        },
      });
    }

    async function submitRange(event) {
      event.preventDefault();
      if (!rangeForm) {
        return;
      }
      rangeStatus.textContent = 'Running range test...';
      rangeSummary.innerHTML = rangeSummaryEmpty;
      rangeResults.innerHTML = rangeResultsEmpty;
      rangeRaw.innerHTML = '';
      rangeRaw.hidden = true;
      if (rangeChartInstance) {
        rangeChartInstance.destroy();
        rangeChartInstance = null;
      }

      const payload = {
        mode: 'range',
        data: rangeDataSelect ? rangeDataSelect.value : '',
        lower: parseFloat(rangeLowerInput?.value || '0'),
        upper: parseFloat(rangeUpperInput?.value || '0'),
        min_levels: parseInt(rangeMinLevelsInput?.value || '0', 10),
        max_levels: parseInt(rangeMaxLevelsInput?.value || '0', 10),
        level_step: parseInt(rangeStepInput?.value || '0', 10),
        days_back: parseInt(rangeDaysBackInput?.value || '0', 10),
        fee: parseFloat(rangeFeeInput?.value || '0'),
        quote_balance: parseFloat(rangeQuoteInput?.value || '0'),
        base_balance: parseFloat(rangeBaseInput?.value || '0'),
        risk_free: parseFloat(rangeRiskFreeInput?.value || '0'),
      };

      try {
        const response = await fetch('/api/backtest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await response.json();
        if (!response.ok || !data.success) {
          rangeStatus.textContent = data.error || 'Range test failed.';
          if (data.raw_output) {
            rangeRaw.innerHTML = `<h3>Diagnostics</h3><pre>${data.raw_output}</pre>`;
            rangeRaw.hidden = false;
          }
          return;
        }
        rangeStatus.textContent = `Range test complete (${(data.range_results || []).length} scenarios).`;
        renderRangeSummary(data.range_summary);
        renderRangeTable(data.range_results || []);
        renderRangeChart(data.range_results || []);
        rangeRaw.innerHTML = '';
        rangeRaw.hidden = true;
      } catch (error) {
        console.error(error);
        rangeStatus.textContent = 'Unexpected error. Check console logs.';
        rangeRaw.innerHTML = '';
        rangeRaw.hidden = true;
      }
    }

    if (rangeForm) {
      rangeForm.addEventListener('submit', submitRange);
    }
  </script>
</body>
</html>
